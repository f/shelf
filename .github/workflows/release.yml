name: Build & Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "number=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Update app version in Xcode project
        run: |
          sed -i '' "s/MARKETING_VERSION = .*;/MARKETING_VERSION = ${{ steps.version.outputs.number }};/g" Shelf.xcodeproj/project.pbxproj

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Shelf.xcodeproj/project.pbxproj
          git commit -m "Bump version to ${{ steps.version.outputs.number }}" || echo "No changes to commit"
          git push origin HEAD:refs/heads/master || echo "Push skipped"

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer

      - name: Build universal app
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Upload DMG to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/release/Shelf.dmg
          name: Shelf ${{ steps.version.outputs.tag }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Installation

            1. Download **Shelf.dmg** below
            2. Open the DMG and drag **Shelf** to Applications
            3. Since the app is not notarized, macOS may block it on first launch. Run the following command in Terminal to fix this:

            ```
            xattr -cr /Applications/Shelf.app
            ```

            Then open Shelf normally.

            Or install via Homebrew:

            ```
            brew install f/shelf/shelf
            ```

      - name: Compute DMG SHA256
        id: sha
        run: echo "sha256=$(shasum -a 256 build/release/Shelf.dmg | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Update Homebrew Cask tap
        env:
          TAP_REPO_TOKEN: ${{ secrets.TAP_REPO_TOKEN }}
          VERSION: ${{ steps.version.outputs.tag }}
          SHA256: ${{ steps.sha.outputs.sha256 }}
        run: |
          VERSION_NUM="${VERSION#v}"
          git clone https://x-access-token:${TAP_REPO_TOKEN}@github.com/f/homebrew-shelf.git tap
          mkdir -p tap/Casks
          cat > tap/Casks/shelf.rb << EOF
          cask "shelf" do
            version "${VERSION_NUM}"
            sha256 "${SHA256}"

            url "https://github.com/f/shelf/releases/download/${VERSION}/Shelf.dmg"
            name "Shelf"
            desc "Your macOS dock, powered up. Floating shelves for apps, links, and snippets."
            homepage "https://github.com/f/shelf"

            depends_on macos: ">= :sequoia"

            app "Shelf.app"

            postflight do
              system_command "/usr/bin/xattr", args: ["-cr", "#{appdir}/Shelf.app"]
            end

            zap trash: [
              "~/Library/Preferences/dev.fka.Shelf.plist",
              "~/Library/Saved Application State/dev.fka.Shelf.savedState",
              "~/Library/Application Support/Shelf",
            ]
          end
          EOF
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Update Shelf to ${VERSION}"
          git push
